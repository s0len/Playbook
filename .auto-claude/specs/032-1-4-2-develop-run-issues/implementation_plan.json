{
  "feature": "Fix Playbook v1.4.2 NHL File Processing Failures",
  "workflow_type": "investigation",
  "workflow_rationale": "This task requires investigation of three distinct failure modes before implementing fixes: (1) AttributeError crash in destination_builder.py, (2) NHL season resolution failure for date-based patterns, and (3) team name pollution from quality metadata. The error logs provide symptoms but not root causes. We must trace through matcher logic, destination builder, and pattern configuration to identify where the system breaks down. This is diagnostic work followed by targeted bug fixes.",
  "phases": [
    {
      "id": "phase-1-reproduce",
      "name": "Reproduce & Analyze Failures",
      "type": "investigation",
      "description": "Reproduce the three failure modes and document root causes through code analysis and debugging",
      "depends_on": [],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Investigate AttributeError in destination_builder.py",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "src/playbook/destination_builder.py",
            "src/playbook/processor.py",
            "src/playbook/matcher.py"
          ],
          "expected_output": "Documentation identifying: (1) Where build_destination() is called with wrong type, (2) Why PatternConfig is passed instead of PatternRuntime, (3) Which file needs fixing (likely processor.py)",
          "verification": {
            "type": "manual",
            "instructions": "Review investigation notes - must identify exact location where PatternConfig is incorrectly passed to build_destination()"
          },
          "status": "completed",
          "notes": "Investigation completed successfully. Identified TWO distinct locations where PatternConfig is incorrectly passed instead of PatternRuntime: (1) matcher.py:1078 in regex matching path - returns pattern_runtime.config instead of pattern_runtime, (2) matcher.py:845+873 in structured filename matching path - creates bare PatternConfig instead of wrapping in PatternRuntime. Root cause: build_destination() expects PatternRuntime with .config attribute, but receives PatternConfig which has no .config attribute. Complete investigation documented in investigation-notes-subtask-1-1.md",
          "updated_at": "2026-01-08T12:47:14.632552+00:00"
        },
        {
          "id": "subtask-1-2",
          "description": "Investigate season resolution failure for date-based NHL patterns",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "src/playbook/matcher.py"
          ],
          "expected_output": "Documentation explaining: (1) Why selector value is None despite having day/month/year groups, (2) How date mode should construct date from components, (3) Whether fix belongs in _resolve_selector_value() or _select_season()",
          "verification": {
            "type": "manual",
            "instructions": "Review investigation notes - must document current date mode logic flow and identify missing date construction step"
          },
          "status": "completed",
          "notes": "Investigation completed successfully. Root cause identified: date mode in _select_season() only handles unified 'date' groups, not separate day/month/year components. When NHL pattern extracts {'day': '07', 'month': '01', 'year': '2025'}, _resolve_selector_value() returns None because it looks for a 'date' key that doesn't exist. Solution: Add fallback to existing _parse_date_from_groups() helper function (lines 43-58) in _select_season() date mode (lines 338-349). This is a simple 3-line addition that leverages existing, tested code. Complete investigation documented in investigation-notes-subtask-1-2.md with logic flow analysis, root cause, fix location, and verification strategy.",
          "updated_at": "2026-01-08T12:49:13.347876+00:00"
        },
        {
          "id": "subtask-1-3",
          "description": "Investigate team name pollution from quality metadata",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "src/playbook/matcher.py"
          ],
          "expected_output": "Documentation explaining: (1) Why quality tags are captured in team names, (2) Whether regex needs tightening or post-processing needed, (3) Whether existing _strip_team_noise() function can be reused",
          "verification": {
            "type": "manual",
            "instructions": "Review investigation notes - must propose solution (regex fix vs post-processing)"
          },
          "status": "completed",
          "notes": "Investigation completed successfully. Root cause identified: regex pattern <matchup_team> is greedy and captures quality metadata (720p60_EN_Utah16) as part of team names. Existing _strip_team_noise() function (lines 696-712) handles all quality metadata types but is NOT applied to away/home values from regex groups. RECOMMENDED SOLUTION: Post-processing approach - apply _strip_team_noise() to away/home values in _select_episode() after line 466. This is clean, safe, low-risk, and reuses existing tested code. Implementation: Add 4 lines after matcher.py:466 to strip noise before canonicalization. Complete investigation documented in investigation-notes-subtask-1-3.md with pattern analysis, code analysis, two solution options evaluated, and recommended approach with test cases.",
          "updated_at": "2026-01-08T12:52:55.242377+00:00"
        }
      ]
    },
    {
      "id": "phase-2-fix-critical",
      "name": "Fix Critical AttributeError",
      "type": "implementation",
      "description": "Fix the AttributeError crash that blocks all file processing",
      "depends_on": [
        "phase-1-reproduce"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Fix AttributeError - ensure PatternRuntime is passed to build_destination()",
          "service": "main",
          "files_to_modify": [
            "src/playbook/processor.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/playbook/processor.py",
            "src/playbook/destination_builder.py"
          ],
          "verification": {
            "type": "command",
            "command": "python -c \"from playbook.processor import FileProcessor; print('Import OK')\"",
            "expected": "Import OK"
          },
          "status": "completed",
          "notes": "Fixed AttributeError by importing PatternRuntime from matcher module and adding proper type annotation to _build_destination method's pattern parameter. Verified with AST analysis.",
          "updated_at": "2026-01-08T12:56:58.689808+00:00"
        },
        {
          "id": "subtask-2-2",
          "description": "Add unit test for destination builder with PatternRuntime",
          "service": "main",
          "files_to_modify": [
            "tests/test_destination_builder.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "tests/test_destination_builder.py"
          ],
          "verification": {
            "type": "command",
            "command": "pytest tests/test_destination_builder.py -v",
            "expected": "All tests pass"
          },
          "status": "completed",
          "notes": "Successfully added test_with_pattern_runtime_object() to tests/test_destination_builder.py. Test creates real PatternRuntime and PatternConfig objects to verify attribute access pattern (pattern.config.destination_root_template) works correctly without AttributeError. Follows existing test patterns using Mock objects for SportRuntime and Settings. Test validates that pattern-level templates override sport and default templates. Changes committed with descriptive message.",
          "updated_at": "2026-01-08T13:00:38.010329+00:00"
        }
      ]
    },
    {
      "id": "phase-3-fix-season",
      "name": "Fix NHL Season Resolution",
      "type": "implementation",
      "description": "Implement date-to-season conversion for NHL files with DD-MM-YYYY format",
      "depends_on": [
        "phase-1-reproduce"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Implement date construction from day/month/year groups in matcher.py",
          "service": "main",
          "files_to_modify": [
            "src/playbook/matcher.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/playbook/matcher.py"
          ],
          "verification": {
            "type": "command",
            "command": "python -c \"from playbook.matcher import _parse_date_from_groups; import datetime; result = _parse_date_from_groups({'day': '07', 'month': '01', 'date_year': '2025'}); assert result == datetime.date(2025, 1, 7); print('OK')\"",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Function _parse_date_from_groups was already correctly implemented in matcher.py. Verified it constructs dates correctly from day/month/year groups with test case datetime.date(2025, 1, 7) from groups {'day': '07', 'month': '01', 'date_year': '2025'}.",
          "updated_at": "2026-01-08T13:02:40.742340+00:00"
        },
        {
          "id": "subtask-3-2",
          "description": "Add unit tests for date-based season resolution",
          "service": "main",
          "files_to_modify": [
            "tests/test_matcher.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "tests/test_matcher.py"
          ],
          "verification": {
            "type": "command",
            "command": "pytest tests/test_matcher.py::test_nhl_date_season_resolution -v",
            "expected": "Test passes"
          },
          "status": "pending",
          "notes": "Add tests for: (1) 2025-01-07 \u2192 2025-2026 season, (2) 2025-10-01 \u2192 2025-2026 season (season start), (3) Invalid dates handled gracefully"
        }
      ]
    },
    {
      "id": "phase-4-fix-teams",
      "name": "Fix Team Name Extraction",
      "type": "implementation",
      "description": "Clean quality metadata from team names using existing _strip_team_noise() function",
      "depends_on": [
        "phase-1-reproduce"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Apply _strip_team_noise() to away/home team captures in matcher.py",
          "service": "main",
          "files_to_modify": [
            "src/playbook/matcher.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/playbook/matcher.py"
          ],
          "verification": {
            "type": "command",
            "command": "python -c \"from playbook.matcher import _strip_team_noise; result = _strip_team_noise('Utah Mammoth 720p60_EN_Utah16'); assert result == 'Utah Mammoth', f'Expected Utah Mammoth, got {result}'; print('OK')\"",
            "expected": "OK"
          },
          "status": "pending",
          "notes": "In match_file_to_episode(), after extracting away/home from match groups, apply _strip_team_noise() to clean them. Likely around line 956 where groups are extracted."
        },
        {
          "id": "subtask-4-2",
          "description": "Add unit tests for team name cleaning",
          "service": "main",
          "files_to_modify": [
            "tests/test_matcher.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "tests/test_matcher.py"
          ],
          "verification": {
            "type": "command",
            "command": "pytest tests/test_matcher.py::test_nhl_team_name_cleaning -v",
            "expected": "Test passes"
          },
          "status": "pending",
          "notes": "Add tests for: (1) Team with 720p60 quality tag, (2) Team with 1080p60 quality tag, (3) Team with source code like _EN_TNT"
        }
      ]
    },
    {
      "id": "phase-5-integration",
      "name": "Integration Testing",
      "type": "integration",
      "description": "Verify all fixes work together end-to-end with NHL test files",
      "depends_on": [
        "phase-2-fix-critical",
        "phase-3-fix-season",
        "phase-4-fix-teams"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-5-1",
          "description": "Integration test with exact NHL filename from GitHub issue",
          "service": "main",
          "files_to_modify": [
            "tests/test_matcher.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "tests/test_matcher.py",
            "tests/test_processor.py"
          ],
          "verification": {
            "type": "command",
            "command": "pytest tests/test_matcher.py::test_nhl_integration_github_issue_86 -v",
            "expected": "Test passes"
          },
          "status": "pending",
          "notes": "Test with filename: 'NHL 07-01-2025 RS Ottawa Senators vs. Utah Mammoth 720p60_EN_Utah16.mkv'. Must verify: (1) Season resolves to 2025-2026, (2) Home team = 'Utah Mammoth', (3) Away team = 'Ottawa Senators', (4) No AttributeError"
        },
        {
          "id": "subtask-5-2",
          "description": "Run full test suite to verify no regressions",
          "service": "main",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "pytest tests/ -v --tb=short",
            "expected": "All tests pass"
          },
          "status": "pending",
          "notes": "Ensure no regressions in Formula 1, NBA, NFL, MotoGP, or IndyCar processing"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 5,
    "total_subtasks": 11,
    "services_involved": [
      "main"
    ],
    "parallelism": {
      "max_parallel_phases": 2,
      "parallel_groups": [
        {
          "phases": [
            "phase-3-fix-season",
            "phase-4-fix-teams"
          ],
          "reason": "Both depend only on phase-1-reproduce and modify different parts of matcher.py without file conflicts"
        }
      ],
      "recommended_workers": 1,
      "speedup_estimate": "1.3x faster than sequential (investigation blocks parallelism)"
    },
    "startup_command": "source auto-claude/.venv/bin/activate && python auto-claude/run.py --spec 032-1-4-2-develop-run-issues --parallel 1"
  },
  "verification_strategy": {
    "risk_level": "medium",
    "skip_validation": false,
    "test_creation_phase": "per_phase",
    "test_types_required": [
      "unit",
      "integration"
    ],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "All existing tests pass",
      "New unit tests cover date-to-season conversion",
      "New unit tests cover team name cleaning",
      "Integration test with exact filename from GitHub Issue #86 passes",
      "No AttributeError crashes occur",
      "NHL files with DD-MM-YYYY format successfully process"
    ],
    "verification_steps": [
      {
        "name": "Unit Tests",
        "command": "pytest tests/test_matcher.py tests/test_destination_builder.py -v",
        "expected_outcome": "All tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Integration Tests",
        "command": "pytest tests/test_processor.py -v",
        "expected_outcome": "All integration tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Full Test Suite",
        "command": "pytest tests/ -v",
        "expected_outcome": "All tests pass, no regressions",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Linting",
        "command": "ruff check src/",
        "expected_outcome": "No linting errors",
        "type": "quality",
        "required": true,
        "blocking": false
      }
    ],
    "reasoning": "Medium risk requires unit and integration test coverage. Matcher is core component but has existing test suite. Changes are targeted fixes not architectural changes."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": [
        "pytest tests/test_matcher.py -v",
        "pytest tests/test_destination_builder.py -v"
      ],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": true,
      "commands": [
        "pytest tests/test_processor.py -v"
      ],
      "services_to_test": [
        "main"
      ]
    },
    "e2e_tests": {
      "required": false,
      "commands": [],
      "flows": []
    },
    "browser_verification": {
      "required": false,
      "pages": []
    },
    "database_verification": {
      "required": false,
      "checks": []
    },
    "manual_verification": {
      "required": true,
      "steps": [
        "Run application with test NHL files: python -m playbook.cli run --log-level DEBUG",
        "Verify no AttributeError crashes occur",
        "Check logs show season resolution succeeds for date-based NHL patterns",
        "Verify team names in logs do not include quality metadata (e.g., 720p60, source codes)"
      ]
    }
  },
  "qa_signoff": null,
  "status": "in_progress",
  "planStatus": "in_progress",
  "updated_at": "2026-01-08T12:44:18.049Z",
  "last_updated": "2026-01-08T13:02:40.742347+00:00"
}